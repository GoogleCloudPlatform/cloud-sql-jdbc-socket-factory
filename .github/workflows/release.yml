# Copyright 2023 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: release-please
on:
  push:
    branches:
      - main
jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      pr: ${{ steps.release-please.outputs.pr }}
      releases_created: ${{ steps.release-please.outputs.releases_created }}
      release_tag: ${{ steps.release-please.outputs.tag_name }}
    steps:
      - uses: GoogleCloudPlatform/release-please-action@v3.5.0
        id: release-please
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          release-type: simple
          package-name: cloud-sql-java-connector
  
  update-pom-files:
    runs-on: ubuntu-latest
    needs: release-please
    if: ${{ needs.release-please.outputs.pr }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: update pom.xml files
        run: ./.release/update_versions.sh
      - name: push commit
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "update versions in pom.xml files and READMEs"
          ref: ${{ fromJson(needs.release-please.outputs.pr).headBranchName }}   

  upload_uberjars:
    runs-on: ubuntu-latest
    needs: release-please
    if: ${{ needs.release-please.outputs.releases_created }}
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - id: auth
      name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1.0.0
      with:
        workload_identity_provider: ${{ secrets.PROVIDER_NAME }}
        service_account: ${{ secrets.SERVICE_ACCOUNT }}
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
    - name: Cloud Build
      id: cloudbuild
      env:
        RELEASE_PROJECT: '${{ secrets.RELEASE_PROJECT }}'
        BUCKET_NAME: '${{ secrets.RELEASE_BUCKET_NAME }}'
      run: |
        export VERSION=$(cat version.txt)
        gcloud config set project $RELEASE_PROJECT
        gcloud builds submit --config .release/upload_uberjars.yaml \
          --substitutions=_VERSION="$VERSION",_BUCKET_NAME="$BUCKET_NAME"
    - name: Cleanup Bucket
      run: |
        gsutil rm -f gs://"$BUCKET_NAME"/v"$VERSION"/*.json 2> /dev/null || true 
    - name: Generate SHA
      id: generate_sha
      run: |
        ./.release/generate_sha.sh
        echo "RELEASE_TABLE=$(cat release_table.md)" >> $GITHUB_ENV
    - name: Update Release Notes
      id: update_release
      uses: tubone24/update_release@v1.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        RELEASE_TAG: ${{ needs.release-please.outputs.release_tag }}
      with:
        body: ${{ env.RELEASE_TABLE }}
  
  snapshot-pr:
    runs-on: ubuntu-latest
    needs: upload_uberjars
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'
    - name: update version.txt
      run: ./.release/snapshot.sh
    - name: update pom.xml files
      run: ./.release/update_versions.sh
    - name: create pull request
      uses: peter-evans/create-pull-request@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        title: 'chore: update to latest SNAPSHOT version'
        body: |
          Auto-generated by [create-pull-request][1]
          [1]: https://github.com/peter-evans/create-pull-request
        labels: |
            tests: run
            kokoro:force-run
            automerge
        branch: update-version-snapshot
        delete-branch: true
        draft: false

# Copyright 2023 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: release
on:
  push:
    branches:
      - main

# Declare default permissions as read only.
permissions: read-all

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      pr: ${{ steps.release-please.outputs.pr }}
      releases_created: ${{ steps.release-please.outputs.releases_created }}
      release_tag: ${{ steps.release-please.outputs.tag_name }}
    steps:
      - uses: GoogleCloudPlatform/release-please-action@069d7229d7b10308de85bc606a91e0033e259c8e # v3.5.0
        id: release-please
        with:
          token: ${{ secrets.RELEASE_BOT_PAT }}
          release-type: simple
          package-name: cloud-sql-java-connector
  
  update-pom-files:
    runs-on: ubuntu-latest
    needs: release-please
    if: ${{ needs.release-please.outputs.pr }}
    steps:
      - name: Checkout code
        uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada57f0ab # v3.5.2
        with:
          token: ${{ secrets.RELEASE_BOT_PAT }}
          ref: ${{ fromJson(needs.release-please.outputs.pr).headBranchName }}
      - name: update pom.xml files
        run: ./.release/update_versions.sh
      - name: push commit
        uses: stefanzweifel/git-auto-commit-action@3ea6ae190baf489ba007f7c92608f33ce20ef04a # v4.16.0
        with:
          commit_message: "update versions in pom.xml files and READMEs"
          branch: ${{ fromJson(needs.release-please.outputs.pr).headBranchName }}   

  upload_uberjars:
    runs-on: ubuntu-latest
    needs: release-please
    if: ${{ needs.release-please.outputs.releases_created }}
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
    - name: Checkout code
      uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada57f0ab # v3.5.2
    - id: auth
      name: Authenticate to Google Cloud
      uses: google-github-actions/auth@ef5d53e30bbcd8d0836f4288f5e50ff3e086997d # v1.0.0
      with:
        workload_identity_provider: ${{ secrets.PROVIDER_NAME }}
        service_account: ${{ secrets.SERVICE_ACCOUNT }}
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@e30db14379863a8c79331b04a9969f4c1e225e0b # v1.1.1
    - name: set version
      run: |
        echo "VERSION=$(cat version.txt)" >> $GITHUB_ENV
    - name: Cloud Build
      id: cloudbuild
      env:
        CLOUDSDK_CORE_PROJECT: '${{ secrets.RELEASE_PROJECT }}'
        BUCKET_NAME: '${{ secrets.RELEASE_BUCKET_NAME }}'
      run: |
        gcloud builds submit --config .release/upload_uberjars.yaml \
          --substitutions=_VERSION="$VERSION",_BUCKET_NAME="$BUCKET_NAME"
    - name: Cleanup Bucket
      env:
        BUCKET_NAME: '${{ secrets.RELEASE_BUCKET_NAME }}'
      run: |
        gsutil rm -f gs://"$BUCKET_NAME"/v"$VERSION"/*.json 2> /dev/null || true 
    - name: Generate SHA
      id: generate_sha
      env:
        BUCKET_NAME: '${{ secrets.RELEASE_BUCKET_NAME }}'
      run: |
        ./.release/generate_sha.sh
        echo 'RELEASE_TABLE<<EOF' >> $GITHUB_ENV
        cat release_table.md >> $GITHUB_ENV
        echo 'EOF' >> $GITHUB_ENV
    - name: Update Release Notes
      id: update_release
      uses: tubone24/update_release@c04c17054b939144ec8a7cba969d74992f812d66 # v1.3.1
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_BOT_PAT }}
        TAG_NAME: ${{ needs.release-please.outputs.release_tag }}
      with:
        body: ${{ env.RELEASE_TABLE }}
        is_append_body: true
  
  snapshot-pr:
    runs-on: ubuntu-latest
    needs: upload_uberjars
    steps:
    - name: Checkout
      uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada57f0ab # v3.5.2
    - name: Set up JDK 17
      uses: actions/setup-java@5ffc13f4174014e2d4d4572b3d74c3fa61aeb2c2 # v3.11.0
      with:
        distribution: 'zulu'
        java-version: '17'
    - name: update version.txt
      run: ./.release/snapshot.sh
    - name: update pom.xml files
      run: ./.release/update_versions.sh
    - name: create pull request
      uses: peter-evans/create-pull-request@5b4a9f6a9e2af26e5f02351490b90d01eb8ec1e5 # v5.0.0
      with:
        token: ${{ secrets.RELEASE_BOT_PAT }}
        title: 'chore: update to latest SNAPSHOT version'
        body: |
          Auto-generated by [create-pull-request](https://github.com/peter-evans/create-pull-request).
        labels: |
            tests: run
            automerge
        branch: update-version-snapshot
        delete-branch: true
        draft: false
